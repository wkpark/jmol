<project name="Jmol release to Sonatype OSSRH repository" default="dist" basedir=".." xmlns:artifact="antlib:org.apache.maven.artifact.ant">

  <!--
    To use this script, we need to add the tools/maven-ant-tasks-2.1.3.jar to the class path.
    For details, see https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide#SonatypeOSSMavenRepositoryUsageGuide-4.MavenRepositories
  -->
  <taskdef uri="antlib:org.apache.maven.artifact.ant"
    resource="org/apache/maven/artifact/ant/antlib.xml">
    <classpath>
      <pathelement location="tools/maven-ant-tasks-2.1.3.jar" />
    </classpath>
  </taskdef>

  <property name="src" location="src" />
  <property name="dist" location="build/dist" />
  <property name="dist-maven" location="build/dist-maven" />

  <!-- define Maven coordinates -->
  <property name="groupId" value="net.sourceforge.jmol" />
  <property name="artifactId" value="jmol" />
  
  <property file="${dist}/Jmol.properties" prefix="Jmol.properties" />
  <property name="version" value="${Jmol.properties.version}" />

  <!-- define artifacts' name, which follows the convention of Maven -->
  <property name="maven-jar" value="${dist-maven}/${artifactId}-${version}.jar" />
  <property name="maven-javadoc-jar" value="${dist-maven}/${artifactId}-${version}-javadoc.jar" />
  <property name="maven-sources-jar" value="${dist-maven}/${artifactId}-${version}-sources.jar" />

  <!-- defined maven snapshots and staging repository id and url -->
  <property name="maven-snapshots-repository-id" value="sonatype-nexus-snapshots" />
  <property name="maven-snapshots-repository-url" value="https://oss.sonatype.org/content/repositories/snapshots/" />
  <property name="maven-staging-repository-id" value="sonatype-nexus-staging" />
  <property name="maven-staging-repository-url" value="https://oss.sonatype.org/service/local/staging/deploy/maven2/" />
  <property name="maven-releases-repository-id" value="releases" />

  <target name="dist" description="generate the distribution">
    <!-- create the dist folder-->
    <delete dir="${dist-maven}" />
    <mkdir dir="${dist-maven}" />

    <!-- copy the pom.xml file -->
    <copy file="${dist}/pom.xml" tofile="${dist-maven}/pom.xml" />
    
    <!-- copy the jar artifact -->
    <copy file="${dist}/Jmol.jar" tofile="${maven-jar}" />

    <!-- copy the javadoc artifact -->
    <copy file="${dist}/jmol-${version}-javadoc.jar" tofile="${maven-javadoc-jar}" />

    <!-- copy the sources artifact -->
    <copy file="${dist}/jmol-${version}-sources.jar" tofile="${maven-sources-jar}" />
  </target>
  
  <target name="snapshot" depends="dist" description="deploy snapshot version to Maven snapshot repository">
    <artifact:mvn>
      <arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
      <arg value="-Durl=${maven-snapshots-repository-url}" />
      <arg value="-DrepositoryId=${maven-snapshots-repository-id}" />
      <arg value="-DpomFile=${dist-maven}/pom.xml" />
      <arg value="-Dfile=${maven-jar}" />
    </artifact:mvn>
  </target>

  <target name="deploy" depends="dist" description="deploy release version to Maven staging repository">
    <!-- sign and deploy the main artifact -->
    <artifact:mvn>
      <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
      <arg value="-Durl=${maven-staging-repository-url}" />
      <arg value="-DrepositoryId=${maven-staging-repository-id}" />
      <arg value="-DpomFile=${dist-maven}/pom.xml" />
      <arg value="-Dfile=${maven-jar}" />
      <arg value="-Pgpg" />
    </artifact:mvn>

    <!-- sign and deploy the sources artifact -->
    <artifact:mvn>
      <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
      <arg value="-Durl=${maven-staging-repository-url}" />
      <arg value="-DrepositoryId=${maven-staging-repository-id}" />
      <arg value="-DpomFile=${dist-maven}/pom.xml" />
      <arg value="-Dfile=${maven-sources-jar}" />
      <arg value="-Dclassifier=sources" />
      <arg value="-Pgpg" />
    </artifact:mvn>

    <!-- sign and deploy the javadoc artifact -->
    <artifact:mvn>
      <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
      <arg value="-Durl=${maven-staging-repository-url}" />
      <arg value="-DrepositoryId=${maven-staging-repository-id}" />
      <arg value="-DpomFile=${dist-maven}/pom.xml" />
      <arg value="-Dfile=${maven-javadoc-jar}" />
      <arg value="-Dclassifier=javadoc" />
      <arg value="-Pgpg" />
    </artifact:mvn>

  </target>
  
  <target name="close" description="close the current staging repository">
    <!-- close the staging repository -->
    <artifact:mvn>
      <arg value="nexus:staging-close" />
      <arg value="-Dnexus.serverAuthId=${maven-staging-repository-id}" />
    </artifact:mvn>
  </target>

  <target name="promote" description="promote the closed staging repository to release repository">
    <!-- promote the release -->
    <artifact:mvn>
      <arg value="nexus:staging-promote" />
      <arg value="-Dnexus.promote.autoSelectOverride=true" />
      <arg value="-Dnexus.serverAuthId=${maven-staging-repository-id}" />
      <arg value="-DtargetRepositoryId=${maven-releases-repository-id}" />
    </artifact:mvn>
  </target>

  <target name="release" depends="deploy,close,promote" description="deploy and release a new version of Jmol to the Sonatype Maven repository">
  </target>

  <target name="clean" description="clean up">
    <delete dir="${dist-maven}" />
  </target>

</project>
